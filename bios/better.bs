-- 2022.07.14 | 6
local n='boot/kernel/pipes OS.lua init.lua'local X,m,W,V,U,T,S,f,e,l,R,Q,P,O,N,M,L,K,J,d,c,b,I,H,G,k,g,F,j,E,D,C,B,A,z,y,x='component','0','filesystem',13,59,48,12,15,1000,50,16,200,208,29,{},1,0,1,-1,unicode,computer,component,'key_down',true,false,pairs,math,pcall;local w,v,u,t,s,i,h,r,q=c.shutdown,H,H,d.len,d.sub,b.proxy,b.list,c.beep,c.pullSignal;local function d(b)return i(h(b)())end;local p=d('eeprom')local b=s(p.get(),-2)if s(b,1,1)==m then v=G end;if s(b,2)==m then u=G end;local function b(g,f)local e,d={},''for c=1,t(g)do local b=s(g,c,c)if b==f then e[#e+1]=d;d=''elseif c==t(g)then d=d..b;e[#e+1]=d else d=d..b end end;return e end;local c=b(n,' ')local function o()N={}for f in k(h(W))do local e=i(f)for b,b in k(c)do local d,c,b=e.open(b,'r'),''repeat b=e.read(d,g.huge)c=c..(b or'')until not b;e.close(d)if c~=''then local d=load(c)if d then local c=s(f,1,V)..'...'..s(f,-7)local b=i(f).getLabel()b=b..string.rep(' ',R-t(b))N[#N+1]={c,b,f,d}break end end end end end;local function n()local g=d('screen')for b in h('screen')do if#i(b).getKeyboards()>0 then g=b end end;local f,e,d,c=0;for b in h('gpu')do d=i(b)d.bind(g)c=d.maxDepth()if c>f then f=c;e=b end end;i(g).turnOn()j=i(e)j.bind(g)j.setResolution(l,R)E,D,C,B=j.setForeground,j.setBackground,j.fill,j.set end;local function m()E(J)D(0)C(1,1,l,R,' ')end;local function l(b,c)m()B(25-t(b)/2,1,b)local b=3*c;C(5,2,41,1,'─')C(5,f-b,41,1,'─')C(5,3,1,S-b,'│')C(46,3,1,S-b,'║')B(5,2,'╭')B(5,f-b,'╰')B(46,2,'╖')B(46,f-b,'╜')if c==1 then C(O,3,1,9,'│')B(O,2,'┬')B(O,S,'┴')end end;local function k(b)if b then B(1,V,'╳ F5: Set EEPROM data as booting '..W)B(1,14,'╳ F6: OpenOS compatibility')B(3,f,'F8: Show boot files')B(3,R,'F9: Shutdown')if v then B(1,V,'√')end;if u then B(1,14,'√')B(1,V,' ')end else B(1,R,'F1: Go to menu')end end;local function j(d,c,b)C(T,2,2,S,' ')if d then B(T,7-b,'◢')B(49,7-b,'◣')end;if c then B(T,10-b,'◥')B(49,10-b,'◤')end end;local function i(c,b)if b==0 then if x>0 then x=x-1 end elseif x<c-S then x=x+1 end end;local function b()C(6,3,40,S,' ')for b=1,S do B(6,2+b,c[b+x])end end;local function h()F(l,'Boot files',0)F(k,G)x=0;while H do F(b,x)F(j,x>0,x<#c-S,0)y={q()}z=y[1]A=y[4]if z==I then if A==U then break end;if A==Q then i(#c,0)end;if A==P then i(#c,1)end elseif s(z,1,9)==X then F(n)end end end;local function f()r(e,0.4)r(e,0.4)end;local function g()m()k(G)B(16,8,'OS exit from main cycle')f()end;local function e(c)C(6,3,40,S,' ')for b=1,S do B(6,2+b,c[b+x])end end;local function c(f)local e,d,c='',{}for b=0,t(f)do c=s(f,b,b)if c=='\n'or t(e)>39 then d[#d+1]=e;e=''elseif c=='\t'then e=e..' 'elseif c~='\r'then e=e..c end end;return d end;local function d(b)f()local b=c(s(b,1,-105))x=0;F(l,'ERROR',0)F(k,G)while H do F(e,b,x)F(j,x>0,x<#b-S,0)y={q()}z=y[1]A=y[4]if z==I then if A==U then break end;if A==Q then i(#b,0)end;if A==P then i(#b,1)end elseif s(z,1,9)==X then F(n)end end end;local function f(b)F(m)if v then p.setData(b[3])end;if u then computer.getBootAddress=p.getData;computer.setBootAddress=function(b)return p.setData(b)end end;local c,b=xpcall(b[4],debug.traceback)F(n)if not c then d(b)else F(g)while H do y={q()}if y[1]==I and y[4]==U then break end end end;w(1)end;local function e()if#N>0 then for b=1,9 do if b==M then E(0)D(J)end;B(6,2+b,N[b+L][1])B(30,2+b,N[b+L][2])if b==M then E(J)D(0)end end end end;local function d()o()l('Select boot device',1)k(H)end;local function c(b)if b==0 then if M>1 then M=M-1 else L=L-1 end else if M<9 then M=M+1 else L=L+1 end end end;local function b()F(d)while H do K=M+L;F(e)F(j,K>1,K<#N,2)y={q()}z=y[1]A=y[4]if z==I then if A==Q and K>1 then c(0)elseif A==P and K<#N then c(1)elseif A==28 then f(N[K])elseif A==63 then if not u then if v then v=G else v=H end;F(k,H)end elseif A==64 then if u then u=G else u=H;v=H end;F(k,H)elseif A==66 then h()F(d)elseif A==67 then w()end elseif s(z,1,9)==X then if y[3]==W then if s(z,11,11)=='a'then r(1234)else r(900)end;C(6,3,40,9,' ')C(O,3,1,9,'│')F(o)else F(n)F(d)end end end end;F(n)b()--11